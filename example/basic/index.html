<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Wealthica Connect Example App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="/assets/config.js"></script>

    <!-- Import a published version of Wealthica Browser SDK -->
    <script type="text/javascript" src="https://unpkg.com/wealthica-sdk-js/dist/wealthica.js"></script>
    <!-- Or import from local build -->
    <!-- <script type="text/javascript" src="/assets/wealthica.js"></script> -->
  </head>
  <body>
    <noscript>
      <strong>We're sorry but Wealthica Connect Example App doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app">
      <h1>Wealthica Connect Example App</h1>

      <label for="username">Logged in as</label>
      <input type="text" id="username" value="username_1" />

      <br><br>

      <label for="institution_id">Institution ID</label>
      <input type="text" id="institution_id" value="" />
      <button id="connect">Connect</button>
      <button id="reconnect">Reconnect</button>
      <br><br>

      <div id="connection_error">Connection error: <strong></strong></div>
      <br><br>

      <button id="get_institutions">Get Institutions</button>
      <button id="get_institution">Get Institution</button>
      <button id="get_transactions">Get Transaction</button>

      <div id="result"></div>

      <script type="text/javascript">
        let user;
        let wealthica;
        let institutionId;

        function login() {
          wealthica = Wealthica.init({
            clientId: constants.WEALTHICA_CLIENT_ID,
            authEndpoint: '/wealthica/auth', // default value, but set here for the sake of demo
            auth: {
              headers: { Authorization: `Bearer ${$('#username').val()}` },
            },
            // The following is for Wealthica developers only, remove if you are a Wealthica client
            baseURL: constants.WEALTHICA_API_URL,
            connectURL: constants.WEALTHICA_CONNECT_URL,
          });

          user = wealthica.login();
        }

        $(document).ready(function(){
          $("#connect").click(function() {
            $('#connection_error strong').text('');

            login();

            user.connect().onConnection(function(institution) {
              console.log('connection success', institution);
              $('#institution_id').val(institution);
            }).onError(function(error) {
              console.log('connection error', error);
              $('#connection_error strong').text(error.message);
            });
          });

          $("#reconnect").click(function() {
            const institutionId = $('#institution_id').val();
            if (!institutionId) alert('Must enter an Institution ID first.')
            $('#connection_error strong').text('');

            login();

            user.reconnect(institutionId).onConnection(function(institution) {
              console.log('reconnection success', institution);
              $('#institution_id').val(institution);
            }).onError(function(error) {
              console.log('reconnection error', error);
              $('#connection_error strong').text(error.message);
            });
          });

          $("#get_institutions").click(async function() {
            login();

            try {
              const institutions = await user.institutions.getList();

              $('#result').html('Institutions:<br><code>' + JSON.stringify(institutions) + '</code>');
            } catch (err) {
              $('#result').html('Error:<br><code>' + err + '</code>');
            }
          });

          $("#get_institution").click(async function() {
            const institutionId = $('#institution_id').val();
            if (!institutionId) alert('Must connect an institution first');

            login();

            try {
              const institution = await user.institutions.getOne(institutionId);

              $('#result').html('Institution:<br><code>' + JSON.stringify(institution) + '</code>');
            } catch (err) {
              $('#result').html('Error:<br><code>' + err + '</code>');
            }
          });

          $("#get_transactions").click(async function() {
            const institutionId = $('#institution_id').val();
            if (!institutionId) alert('Must connect an institution first');

            login();

            try {
              const transactions = await user.transactions.getList({ institutionId });

              $('#result').html('Transactions:<br><code>' + JSON.stringify(transactions) + '</code>');
            } catch (err) {
              $('#result').html('Error:<br><code>' + err + '</code>');
            }
          });
        });
      </script>
    </div>
  </body>
</html>
